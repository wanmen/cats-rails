<% content_for :head do %>
   <title>搜索:<%= @title %> | 万门大学</title>
<% end %>
<main class="container" role="main">
  <aside class="col-sm-3">
    <h3 class="page-header">
      <span class="glyphicon glyphicon-check"></span> 筛选条件
    </h3>
    <section>
      <div class="checkbox wm-search-type">
        <label><input type="checkbox" id="alltypes" <% if @type.length == 3 %> checked<% end %> onchange="alltypes()"/>所有普通类型<span class="text-muted">(共<%= @books.length+@videos.length+@articles.length %>项)</span></label>
      </div>
      <div class="wm-lg-left">
        <div class="checkbox">
          <label><input type="checkbox" id="book" <% if @type&&(@type.include?'book') %> checked<% end %> onchange="research()" />图书 <span class="text-muted">(<%= @books.length%>)</span></label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" id="video"  <% if @type&&(@type.include?'video') %> checked<% end %> onchange="research()" />视频 <span class="text-muted"> (<%= @videos.length%>)</span></label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" id="article"  <% if @type&&(@type.include?'article') %> checked<% end %> onchange="research()" />经验贴 <span class="text-muted"> (<%= @articles.length%>)</span></label>
        </div>
      </div>
    </section>

    <section>
      <div class="checkbox wm-search-type">
        <label><input type="checkbox" id="alllists" <% if @list.length == 4 %> checked<% end %> onchange="alllists()"/>所有单子类型<span class="text-muted"> (共<%= @booklists.length+@videolists.length+@articlelists.length+@mixlists.length %>项)</span></label>
      </div>
      <div class="wm-lg-left">
        <div class="checkbox">
          <label><input type="checkbox" id="booklist"  <% if @list&&(@list.include?'book') %> checked<% end %> onchange="research()" />书单<span class="text-muted"> (<%= @booklists.length%>)</span></label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" id="videolist"  <% if @list&&(@list.include?'video') %> checked<% end %> onchange="research()" />视频集<span class="text-muted">  (<%= @videolists.length%>)</span></label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" id="articlelist"  <% if @list&&(@list.include?'article') %> checked<% end %> onchange="research()" />帖子集<span class="text-muted">  (<%= @articlelists.length%>)</span></label>
        </div>
        <div class="checkbox">
          <label><input type="checkbox" id="mixlist"  <% if @list&&(@list.include?'mix') %> checked<% end %> onchange="research()" />综合集 <span class="text-muted"> (<%= @mixlists.length%>)</span></label>
        </div>
      </div>
    </section>
    <% if @tags!=[] %>
    <section>
      <div class="checkbox wm-search-type">
         <label>标签<span class="text-muted"> (共<%= @tags.length %>项)</span></label>
      </div>
      <div class="wm-lg-left">
      <% @tags.each do |t| %>
        <a href="/tags/<%= t.id %>"><%= t.name %></a>
      <% end %>
      </div>
    </section>
    <% end %>
  </aside>

  <article class="col-sm-9">
    <h3 class="page-header">
      搜索结果:<%= @title %><span class="text-muted">(共<%= @allresults.length+@tags.length %>项)</span>
      <span class="wm-quick-link">
        <a href="JavaScript:window.history.back();">返回</a>
      </span>
    </h3>
    <section>
     <% @results.each do |result| %>
      <div>
        <h4>
        <% case result.class.name
        when 'Book'%>
          [图书]
       <% when 'Video'%>
          [视频]
       <% when 'Article' %>
          [经验贴]
       <% when 'List' %>
          <% if result.list_type == BOOKLIST %>
          [书单]
          <% elsif result.list_type == VIDEOLIST %>
          [视频集]
          <% elsif result.list_type == ARTICLELIST %>
          [帖子集]
          <% else %>
          [综合集]
          <% end %>
       <%  else %>
          [Undefined]
       <%  end %>
        <%= link_to result.title,result %>
        </h4>
        <p class="wm-pub-metadata">
          <a href="/scholars/<%= result.user[:id] %>.html"><%= result.user[:name] %></a> 发布于 <%= result.user[:created_at].strftime('%b %d, %Y %H:%M') %>
          <span class="pull-right"><%=result.taglinks.length %>个标签 | <%=result.links.length %>个单子 | <%=result.likes.length %>人喜欢 | <%=result.comments.length %>条评论</span>
        </p>
        <p><%= result.summary[0,200] %>
          <%= link_to "继续阅读",result %>
        </p>
      </div>
      <hr/>
     <% end %>
     <% @tags.each do |tag| %>
      <div>
       标签： <a href="/tags/<%= tag.id %>"><%= tag.name %></a> 
          <%= tag.taglinks.length%>个对应内容
          <%= tag.follows.length%>个关注
          <%= tag.likes.length%>个喜欢
      </div>
      <hr/>
      <% end %>
    </section>

    <section class="text-center">
     <ul class="pagination">
       <% for i in 0..@numberofpages %>
        <li <% if (i == @page) %>class="active"<% end %>><a onclick="showpage(<%= i+1%>)"><%= i+1%></a></li>
       <% end %>
     </ul>
    </section>
  </article>

</main>
<script type="text/javascript">
function gup( name ){
  name = name.replace(/[\[]/,"\\\[").replace(/[\]]/,"\\\]");  
  var regexS = "[\\?&]"+name+"=([^&#]*)";  
  var regex = new RegExp( regexS );  
  var results = regex.exec( window.location.href ); 
  if( results == null )    
    return "";  
  else    
    return results[1];
}
function research(){
  var type = [];
  if(document.getElementById("book").checked)
    type.push('book');
  if (document.getElementById("video").checked)
    type.push('video');
  if (document.getElementById("article").checked)
    type.push('article');
  var list = [];
  if(document.getElementById("booklist").checked)
    list.push('book');
  if (document.getElementById("videolist").checked)
    list.push('video');
  if (document.getElementById("articlelist").checked)
    list.push('article');
  if (document.getElementById("mixlist").checked)
    list.push('mix');
  if (gup('title')!=""){
    window.location = '/search?type='+type.join()+'&list='+list.join()+'&title='+gup('title');
  }else{
    window.location = '/search?type='+type.join()+'&list='+list.join();
  }
}
function alltypes(){
  if(document.getElementById("alltypes").checked){
    document.getElementById("book").checked=true;
    document.getElementById("video").checked=true;
    document.getElementById("article").checked=true;
  }else{
    document.getElementById("book").checked=false;
    document.getElementById("video").checked=false;
    document.getElementById("article").checked=false;
  }
  research();
}
function alllists(){
  if(document.getElementById("alllists").checked){
    document.getElementById("booklist").checked=true;
    document.getElementById("videolist").checked=true;
    document.getElementById("articlelist").checked=true;
    document.getElementById("mixlist").checked=true;
  }else{
    document.getElementById("booklist").checked=false;
    document.getElementById("videolist").checked=false;
    document.getElementById("articlelist").checked=false;
    document.getElementById("mixlist").checked=false;
  }
  research();
}
function showpage(pid){
 window.location= window.location.href+'&page='+pid;
}
</script>